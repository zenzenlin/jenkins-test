pipeline {
  agent any
  stages {
    stage ("Check www.example.com response code") {
      steps{
        sh '''
          # 1. å–å¾— HTTP ç‹€æ…‹ç¢¼
          response_code=$(curl -o /dev/null -s -w "%{http_code}" www.example.com)

          echo "www.example.com response code: ${response_code}"

          # 2. å¦‚æœç‹€æ…‹ç¢¼ä¸æ˜¯ 200ï¼Œå‰‡ä»¥éé›¶ä»£ç¢¼çµæŸ (exit 1)
          if [ "${response_code}" != "200" ]; then
            echo "éŒ¯èª¤ï¼šç¶²ç«™é€£ç·šæª¢æŸ¥å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ç‚º ${response_code}ã€‚ä¸­æ­¢å»ºç½®ã€‚"
            exit 1 // è®“ Stage ç‹€æ…‹è®Šç‚º FAILED
          fi
        '''
      }
    }
  } 
  // ä½¿ç”¨ withCredentials éš±è—æ”¶ä»¶äºº Email
  post {
    // ä½¿ç”¨ withCredentials å¼•ç”¨ Secret textï¼Œä¸¦å°‡å…¶è³¦å€¼çµ¦è®Šæ•¸ RECIPIENT
    withCredentials([string(credentialsId: 'email', variable: 'RECIPIENT')]) { // å‡è¨­ä½ è¨­ç½®çš„ ID ç‚º 'email'
      // ğŸš¨ å¤±æ•—é€šçŸ¥
      failure {
        emailext (
          subject: "[ğŸ”¥ FAILURE ALERT] ${env.JOB_NAME} - ç¶²ç«™é€£ç·šéŒ¯èª¤ï¼",
          body: "è«‹æª¢æŸ¥ Jenkins Build ç´€éŒ„ ${env.BUILD_URL} ä»¥ç²å–è©³ç´°è³‡è¨Šã€‚", // ç°¡åŒ– body é¿å…å†æ¬¡è¤‡è£½è²¼ä¸Šå‡ºéŒ¯
          to: "${RECIPIENT}" 
        )
      }
      // ğŸŸ¢ æˆåŠŸé€šçŸ¥
      success {
        emailext (
          subject: "[âœ… SUCCESS] ${env.JOB_NAME} - å®šæ™‚æª¢æŸ¥æˆåŠŸ",
          body: "é …ç›® ${env.JOB_NAME} ç¶²ç«™æª¢æŸ¥ (www.example.com) æˆåŠŸï¼Œç‹€æ…‹ç¢¼ç‚º 200ã€‚è©³æƒ…: ${env.BUILD_URL}",
          to: "${RECIPIENT}"
        )
      }
    }
  }
}
